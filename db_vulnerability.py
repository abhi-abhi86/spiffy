#⚠️ DO NOT RUN THIS UNDER ANY CIRCUMSTANCES!

#I am not responsible for any damage or misuse.

#This is for educational purposes only.



import sqlite3
import logging
import hashlib
import hmac
import os
import sys
import time
import re
import shutil
from contextlib import contextmanager
from datetime import datetime, timedelta
from typing import Optional, Tuple, List, Dict

# --- CONFIGURATION ---
DB_FILE = "spiffy_vault.db"
LOG_FILE = "spiffy_audit.log"
MAX_LOGIN_ATTEMPTS = 5
LOCKOUT_DURATION_MINUTES = 15

# --- ANSI COLORS ---
C_CYAN = "\033[96m"
C_GREEN = "\033[92m"
C_YELLOW = "\033[93m"
C_RED = "\033[91m"
C_MAGENTA = "\033[95m"
C_BOLD = "\033[1m"
C_END = "\033[0m"
C_CLEAR = "\033[H\033[J"

# Configure persistent logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(name)s: %(message)s',
    handlers=[logging.FileHandler(LOG_FILE)]
)
logger = logging.getLogger("SpiffyVault")

class DatabaseManager:
    """A persistent, production-ready wrapper for database operations."""
    def __init__(self, db_path: str = DB_FILE):
        self.db_path = db_path
        self._initialize_infrastructure()

    @contextmanager
    def get_connection(self):
        conn = sqlite3.connect(self.db_path)
        conn.row_factory = sqlite3.Row
        try:
            yield conn
        finally:
            conn.close()

    def _initialize_infrastructure(self):
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username TEXT UNIQUE NOT NULL,
                    password_hash BLOB NOT NULL,
                    salt BLOB NOT NULL,
                    website TEXT,
                    secret_data TEXT,
                    failed_attempts INTEGER DEFAULT 0,
                    lockout_until TIMESTAMP
                )
            ''')
            cursor.execute("PRAGMA table_info(users)")
            columns = [column[1] for column in cursor.fetchall()]
            if 'website' not in columns:
                cursor.execute('ALTER TABLE users ADD COLUMN website TEXT')
            cursor.execute('CREATE INDEX IF NOT EXISTS idx_username ON users(username)')
            conn.commit()

    def _hash_password(self, password: str, salt: bytes = None) -> Tuple[bytes, bytes]:
        if salt is None:
            salt = os.urandom(16)
        pw_hash = hashlib.scrypt(password.encode(), salt=salt, n=16384, r=8, p=1)
        return pw_hash, salt

    def register_user(self, username: str, password: str, website: str, secret: str) -> Tuple[bool, str]:
        pw_hash, salt = self._hash_password(password)
        with self.get_connection() as conn:
            try:
                conn.execute(
                    "INSERT INTO users (username, password_hash, salt, website, secret_data) VALUES (?, ?, ?, ?, ?)",
                    (username, pw_hash, salt, website, secret)
                )
                conn.commit()
                logger.info(f"Account created: {username}")
                return True, "User registered successfully."
            except sqlite3.IntegrityError:
                return False, "Username already exists."

    def login(self, username: str, password: str) -> Tuple[Optional[Dict], str]:
        now = datetime.now()
        with self.get_connection() as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT * FROM users WHERE username = ?", (username,))
            user = cursor.fetchone()
            if not user: return None, "Access Denied: User identity unknown."

            if user['lockout_until']:
                lockout_time = datetime.fromisoformat(user['lockout_until'])
                if now < lockout_time:
                    wait_time = (lockout_time - now).seconds // 60 + 1
                    return None, f"SECURITY LOCKOUT: Active for {wait_time} more minutes."

            provided_hash, _ = self._hash_password(password, user['salt'])
            if hmac.compare_digest(user['password_hash'], provided_hash):
                conn.execute("UPDATE users SET failed_attempts = 0, lockout_until = NULL WHERE username = ?", (username,))
                conn.commit()
                return {"username": user['username'], "website": user['website'], "secret": user['secret_data']}, "Verified"
            else:
                new_fails = user['failed_attempts'] + 1
                lockout_ts = (now + timedelta(minutes=LOCKOUT_DURATION_MINUTES)).isoformat() if new_fails >= MAX_LOGIN_ATTEMPTS else None
                conn.execute("UPDATE users SET failed_attempts = ?, lockout_until = ? WHERE username = ?", (new_fails, lockout_ts, username))
                conn.commit()
                return None, f"Access Denied: Invalid credentials. (Attempt {new_fails}/{MAX_LOGIN_ATTEMPTS})"

class SpiffyTUI:
    """The Animated Terminal UI for Spiffy."""
    def __init__(self, db_manager):
        self.db = db_manager
        self.running = True

    def clear(self):
        print(C_CLEAR, end="")

    def type_text(self, text, delay=0.03, color=C_END):
        for char in text:
            sys.stdout.write(color + char + C_END)
            sys.stdout.flush()
            time.sleep(delay)
        print()

    def draw_banner(self):
        banner = """
   _____ _____ _____ ______ ________     __
  / ____|  __ \_   _|  ____|  ____\ \   / /
 | (___ | |__) || | | |__  | |__   \ \_/ / 
  \___ \|  ___/ | | |  __| |  __|   \   /  
  ____) | |    _| |_| |    | |       | |   
 |_____/|_|   |_____|_|    |_|       |_|   
        """
        print(C_CYAN + C_BOLD + banner + C_END)
        print(C_YELLOW + " --- The Secure Animated Terminal Vault --- " + C_END)
        print()

    def show_spinner(self, duration=1.0, text="Processing"):
        spinner = ['|', '/', '-', '\\']
        end_time = time.time() + duration
        idx = 0
        while time.time() < end_time:
            sys.stdout.write(f"\r{C_YELLOW}{spinner[idx % 4]} {text}...{C_END}")
            sys.stdout.flush()
            idx += 1
            time.sleep(0.1)
        sys.stdout.write("\r" + " " * (len(text) + 10) + "\r")

    def main_menu(self):
        while self.running:
            self.clear()
            self.draw_banner()
            print(f"{C_BOLD}1.{C_END} Register New Account")
            print(f"{C_BOLD}2.{C_END} Login to Vault")
            print(f"{C_BOLD}3.{C_END} System Exit")
            print("-" * 40)
            choice = input(f"{C_CYAN}Select Command > {C_END}")

            if choice == "1":
                self.handle_registration()
            elif choice == "2":
                self.handle_login()
            elif choice == "3":
                self.type_text("Shutting down Spiffy Vault...", color=C_RED)
                self.running = False
            else:
                self.type_text("Invalid selection.", color=C_RED)
                time.sleep(1)

    def handle_registration(self):
        self.clear()
        self.draw_banner()
        print(f"{C_MAGENTA}--- REGISTER ---{C_END}")
        u = input("New Username: ")
        p = input("New Password (Hidden in DB): ")
        w = input("Website Address: ")
        s = input("Secret Note: ")
        
        self.show_spinner(1.5, "Encrypting credentials")
        success, msg = self.db.register_user(u, p, w, s)
        
        if success:
            self.type_text(msg, color=C_GREEN)
        else:
            self.type_text(msg, color=C_RED)
        time.sleep(2)

    def handle_login(self):
        self.clear()
        self.draw_banner()
        print(f"{C_MAGENTA}--- LOGIN ---{C_END}")
        u = input("Username: ")
        p = input("Password: ")
        
        self.show_spinner(1.0, "Authenticating")
        profile, msg = self.db.login(u, p)
        
        if profile:
            self.show_data_screen(profile)
        else:
            self.type_text(msg, color=C_RED)
            time.sleep(2.5)

    def show_data_screen(self, profile):
        self.clear()
        self.draw_banner()
        self.type_text(f"WELCOME BACK, {profile['username'].upper()}", color=C_GREEN, delay=0.05)
        print("-" * 40)
        self.type_text(f"REGISTERED DOMAIN: {profile['website']}", color=C_CYAN)
        print("-" * 40)
        self.type_text("DECRYPTING SECRET DATA...", color=C_YELLOW)
        self.show_spinner(2.0, "Parsing bytes")
        print()
        self.type_text(f"SECRET: {profile['secret']}", color=C_BOLD, delay=0.1)
        print("-" * 40)
        input(f"\n{C_MAGENTA}Press Enter to safely log out...{C_END}")
        self.show_spinner(0.5, "Clearing session memory")

def main():
    db = DatabaseManager()
    tui = SpiffyTUI(db)
    try:
        tui.main_menu()
    except KeyboardInterrupt:
        print(f"\n{C_RED}Emergency Shutdown Initiated.{C_END}")

if __name__ == "__main__":
    main()
